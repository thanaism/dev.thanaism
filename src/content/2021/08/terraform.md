---
layout: post
title: TerraformとBicep両方さわってみて思ったこと
image: ../../img/matthew-bennett-YWWgHw4PY24-unsplash.jpg
author: [Thanai]
date: 2021-08-07T01:00:00.000+09:00
draft: false
tags:
  - Terraform
excerpt: Bicepとは勝手が違う
---

## AzureでのIaC

さて、クラウド使うのにポチポチしてる時代は縄文時代にもう終わっています。

時代はIaCです。IaCそれすなわちInfrastructure as Codeです。そして、IaCといえばTerraformです。

IaCのメリットだとか、そういう語り尽くされた内容については今さら私が述べる必要もないでしょう。

私が業務で使うクラウドはもっぱらAzureですが、AzureでのIaCとなると`az`コマンドにも組み込まれているMSならではのBicepもあります。

awsなどでも広く使われているマルチプラットフォーム対応のTerraformも当然ですが使えます。

私はBicepをTerraformより先に使い始めました。しばらく触ってみてそれなりに使えるようになりましたが、デファクトのTerraformを知らないというのではやはり居心地が悪いです。

そういうわけでTerraformもひと通り使ってみました。その所感をここに書き出していきます。

## 触ってみて感じた違い

まず、参照関係の解決が大きく異なるので、いわゆる**よい書き方**がガラッと変わる印象を持ちました。

Bicepの場合、デプロイには`az deployment group create -f file.bicep`のようなコマンドで**単一のBicepファイル**を指定します。

そのため、1つのBicepファイルに参照先をキッチリ記述していくスタイルです。

対してTerraformでは、`*.tf`ファイルが含まれるディレクトリ上で`terraform apply`コマンドを叩きます。

このとき、ディレクトリ内（サブディレクトリを除く）に含まれる`*.tf`ファイルはデプロイのすべて対象となり、参照関係を明示的に記述するのは外部のstateファイルやmoduleに限ります。

そのため、ファイル分割でのボトルネックが異なってくる印象を受けました。

Terraformでは、たとえばAzureなら、resource groupとvirtual networkの定義ファイルは同一ディレクトリ内にあるのならば、気軽に分割できます。

一方でBicepの場合は、ファイルを分ける＝参照関係を記述する、なので同一ライフサイクルの別リソースをどこまでまとめるかの問題がよりシビアになる気がします。

## stateファイルの有無

さらに大きな違いとしてstateファイルの有無があります。

### Terraformにはstateファイルが、ある

たとえばvirtual networkをデプロイするとしましょう。このとき、virtual networkのresource IDは実際にデプロイするまで確定しません。

stateファイルには、こういったデプロイ後にはじめて確定する情報等々を含めて、実リソースの**状態**を記述したファイルをローカルに保存して管理します（保存先にリモートのStorageを指定することも可）。

このstateファイルにより、Terraformではより柔軟にリソースの**変更**をIaCで行うことができます。

ただし、このstateファイルを**壊さない**運用が煩雑になります。stateファイルは実際のリソース状態をありのままに記述するゆえに、秘匿情報が含まれます。

チーム開発ではこの管理が重要になるでしょう。ほとんどのケースで、本体の`*.tf`ファイルはリモートリポジトリに、stateファイルはクラウドのBlobストレージに保存することになろうかと思います。

リポジトリのコードがマージされる前にstateファイルが更新されていてはなりませんが、stateファイルを分割・統合するシーンは必ず発生します。

そういった場面でstateファイルを以下に破壊せず動作確認するかなどが課題となるでしょう。その方法についての話は、[前回の記事](https://dev.thanaism.com/2021/08/dividing-terraform-state/)で書いています。

### Bicepにはstateファイルが、ない

一方のBicepではstateファイルを持ちません。

そのため、実リソースとIaC定義の差分を厳密に管理するのが原理的に難しいです。クラウドの構成を頻繁に、かつインクリメンタルに変更したい場合に**思ったとおりにいかない**ことが結構あったりもします。

一方で煩雑なstate管理は一切不要のため、チーム開発でもコードをリポジトリにpushするだけでよいです。ローカルでstateファイルの大手術を行う必要はありません。

たとえば、「とにかく作って壊してを繰り返すので、デプロイ作業は冪等に行いたいが、デプロイ後にプロパティ変更することはほとんどない」といったケースであるとか、テスト用の環境をサクッと立てるといったときにBicepはかなり役に立つと思います。

Bicepの差分管理に関しては、今もいろいろと開発に動きがあるようなので、3ヶ月先はこの記事の限りではないと思います。

## プロダクトの若さと互換性

ある程度の成熟が見えるTerraformと比較して、Bicepは若いです。大きな機能アップデートが頻繁に行われており、これからどんどん育っていくプロダクトになるでしょう。

さらにBicepは、AzureのデフォルトテンプレートであるARMと互換性があります。あくまでサードパーティ製ツールであるTerraformに対し、BicepはAzureのサポート対象です。

Azure CLIにも含まれているため、Terraformのように追加で各種バイナリをインストールする必要がありません。

## ファイルの見通しの良さ

好みの問題かもしれませんが、Bicepは`*.bicep`ファイルで完結するため、シンプルです。

Terraformは`*.tf`を本体に、`*.tfvas`や`*.tfstate`などに分かれます。さらにマルチプラットフォームなので`provider`の定義や、state管理場所である`backend`の定義も必要になり煩雑です。

ここへさらにmodule参照なども入ると、普段コードを書き慣れていないエンジニアが見ても**いったいこの値はどこから来ているんだ？**と陥りやすいような気がします。

## おわりに

ざっくりここまで書いてみての結論です。

- スクラップ＆ビルドではなく、すべてのリソースをIaCで構成変更していくスタイルであればTerraformが向いてそう
- 逆に、「作る」部分に重きが置かれるケースだと面倒なstate管理も必要なくシンプルなBicepが向いてそう

個人的にはBicepの今後の機能アップデートが楽しみです。
